{% extends "bootstrap/base.html" %}
{% block title %}Query Lyric{% endblock %}

{% block navbar %}
{{nav.top.render()}}
{% endblock %}

{% block content %}

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Mali&family=Montserrat:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,400&display=swap" rel="stylesheet"> 

<style>
    html > *, body > * {
        font-family: 'Montserrat', sans-serif;
    }
</style>

<div class="container">
  <h1>Insert Lyric</h1>
  <div>
  <textarea id="query" rows="10" cols="70"></textarea>
  <button id="submit">Submit</button>
  </div>
  <div id="result" style="white-space: pre-wrap;">
	  
  </div>
</div>

<script>
var NUM_CHARS = 50
var total = [];
function queryText(text){
    var api_location = "http://fonil.mtg.upf.edu/predict";
    return $.ajax({
    url: api_location,
    data: {input: text},
    contentType:"applicaton/json",
    });
}

function uniq(a) {
    return a.sort().filter(function(item, pos, ary) {
        return !pos || item != ary[pos - 1];
    });
}

function updateDisplay(text){
	console.log(total)
	console.log("BEGINE");
    var newTotal = uniq(total);
    var prev = 0
    var first = 0
    if (newTotal.length > 0){
	    prev = newTotal[0];
	    first = newTotal[0];
    }
    var result = [];
    for( var i = 0; i < newTotal.length; i++ ){
	if (i > 0 && newTotal[i] < newTotal[i-1]+NUM_CHARS){
	    prev = newTotal[i];
	}else if(i > 0){
	    result.push([first,prev+NUM_CHARS]);
	    first=newTotal[i];
	    prev = newTotal[i];
	}
    }
    if (newTotal.length > result.length){
        result.push([first,prev+NUM_CHARS]);
    }
    //console.log(result)
    resultsText = "";
    prev = 0 ;
    for( var i = 0; i < result.length; i++ ){
	//if (i>0){
	    resultsText += text.substr(prev,result[i][0]);
	//}
	resultsText += '<div style="text-decoration: underline;text-decoration-color: red;">' + text.substr(result[i][0], result[i][1])+ '</div>';
	prev = result[i][1];
    }
    resultsText += text.substr(prev,text.length);
    //console.log(resultsText);
    //$('#result').text("Result: "+avg);
    $('#result').html(resultsText);
}
$( "#submit" ).click(function() {
    $('#result').text("Loading ... ");
    total = [];
    var text = $('#query').val();
    console.log(text.length);
    text.split('.')[0];
    for(var i = 0 ; i < text.length; i +=Math.floor(NUM_CHARS/2))
    {
	console.log(i);
	const printName = function(j){
	queryText(text.substr(i, i+NUM_CHARS)).done(function(toxicCount){
	
	    //console.log(toxicCount);
	    if (toxicCount > 95){
	        total.push(j);
	    }
	    updateDisplay(text);
	})};
	printName(i);
    }
    

    });
</script>
{% endblock %}
