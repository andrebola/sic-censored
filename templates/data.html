{% extends "bootstrap/base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{%block title%} Artist's Data & playlist {%endblock%}
{% block navbar %}
{{nav.top.render()}}
{% endblock %}

{% block content %}
<meta charset="utf-8"/>
<!-- Load d3.js -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="../static/d3.layout.cloud.js"></script>

<style>
	#wordcloud {
    font-size: 60px;
    text-align: center;
    line-height: 370px;
	}
</style>

<div class="container">
	
	<h1>{{data.name}}</h1>
	<div class="row">
		<div class="col">
			<h2>Playlist</h2>
			<div class="row" style="display: flex !important;">
				<iframe src="{{data.playlist}}" width="300" height="380" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
				<div id="wordcloud" style="width: 100%; height: 380px;"></div>
			</div>
    </div>
	</div>
	
</div>

<script>
    var svg_location = "#wordcloud";
    $(svg_location).html("Loading ...");
    $.ajax({
      url: "/ajax/data/{{country}}",
      context: document.body,
      contentType:"applicaton/json",
    }).done(function(word_count) {
      console.log(word_count)
      var width = $("#wordcloud").width();
      var height = $("#wordcloud").height();

      var fill = d3.scale.category20();

      var word_entries = d3.entries(word_count);

      var xScale = d3.scale.linear()
        .domain([0, d3.max(word_entries, function(d) {
          return d.value;
        })
      ])
        .range([10,100]);

      d3.layout.cloud().size([width, height])
        .timeInterval(20)
        .words(word_entries)
        .fontSize(function(d) { return xScale(+d.value); })
        .text(function(d) { return d.key; })
        .rotate(function() { return ~~(Math.random() * 2) * 90; })
        .font("Impact")
        .on("end", draw)
        .start();

      function draw(words) {
        d3.select(svg_location).append("svg")
            .attr("width", width)
            .attr("height", height)
          .append("g")
            .attr("transform", "translate(" + [width >> 1, height >> 1] + ")")
          .selectAll("text")
            .data(words)
          .enter().append("text")
            .style("font-size", function(d) { return xScale(d.value) + "px"; })
            .style("font-family", "Impact")
            .style("fill", function(d, i) { return fill(i); })
            .attr("text-anchor", "middle")
            .attr("transform", function(d) {
              return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
            })
            .text(function(d) { return d.key; });
      }
      d3.layout.cloud().stop();
      $(svg_location).html("");
    });

    /*
    function getRand(min, max) {
        return Math.random() * (max - min) + min;
    }

    function Counter(array) {
      var count = {};
      array.forEach(val => count[val] = (count[val] || 0) + 1);
      return count;
    }

    function blocks(txt, gram) {
        var p = txt + txt.slice(-(gram - 1));
        var arr = [];
        for (i = 0; i < txt.length; ++i) {
          arr.push(p.slice(i, i + gram));
        }
        p = Counter(arr);
        var pd = [];
        Object.keys(p).forEach(x => {
          pd.push(Array(p[x], x))
        });
        pd.sort()
        return pd
    }

    function choices(elems, weights) {
      var totalWeight = 0;
      for (var w in weights) {
          totalWeight += w;
      }
      var random = Math.floor(Math.random() * totalWeight);
      for (var i = 0; i < elems.length; i++) {
        random -= weights[i];
        if (random < 0) {
            return elems[i];
        }
      }
    }

    function create(txt, N, gram) {
      if (gram == 1) {
        var t = '';
        for (i = 0; i < N; ++i) {
          t += txt[getRand(0, txt.length)];
          return t;
        }
      }
      var p = blocks(txt, gram);
      var elems = [];
      var weights = [];
      p.forEach(x => {
        elems.push(x[1])
        weights.push(x[0])
      });
      // so far so good
      var t = choices(elems, weights);
      while (t.length < N) {
        var f = t.slice(-(n + 1));
        var pp = [];
        p.forEach(x => {
          if (x[1].slice(-(n - 1)) == f) {
            pp.push(x);
          }
        });
        var elems_pp = [];
        var weights_pp = [];
        pp.forEach(x => {
          elems_pp.push(x[1])
          weights_pp.push(x[0])
        });
        t = t + choices(elems_pp, weights_pp).pop();
      }
      return t;
    }
    */

    $.ajax({
      url: "/ajax/data/{{country}}/create",
      context: document.body,
      contentType:"text/plain",
    }).done(function(lyrics) {
      console.log(lyrics);
    });
</script>

{% endblock %}
